const { execFile } = require('child_process');
const crypto = require('crypto');
const fs = require('fs');
const path = require('path');
const { db } = require('../config/database');

const ipRegex = /^(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d{2}|[1-9]?\d)){3}$/;

const hostnameRegex = /^(?!-)[A-Za-z0-9-]{1,63}(?<!-)(\.(?!-)[A-Za-z0-9-]{1,63}(?<!-))*$/;

function isValidHost(host) {
  if (typeof host !== 'string') return false;
  const trimmed = host.trim();
  return ipRegex.test(trimmed) || hostnameRegex.test(trimmed);
}

const ping = (req, res) => {
  const { host } = req.body;

  if (!host || !isValidHost(host)) {
    return res.status(400).json({
      error: 'Invalid host'
    });
  }

  const trimmedHost = host.trim();
  const cmd = 'ping';
  const args = process.platform === 'win32'
    ? ['-n', '1', trimmedHost]
    : ['-c', '1', trimmedHost];

  execFile(cmd, args, (error, stdout) => {
    if (error) {
      console.error('Ping error:', error.message);
      return res.status(500).json({
        error: 'Error executing ping'
      });
    }

    const safeStdout = String(stdout || '').replace(/[\r]/g, '');
    const normalizedOutput = `PING ${trimmedHost}\n${safeStdout}`;

    return res.json({
      host: trimmedHost,
      output: normalizedOutput
    });
  });
};


const getCsrfToken = (req, res) => {
  const csrfToken = crypto.randomBytes(32).toString('hex');

  req.session.csrfToken = csrfToken;

  res.cookie('csrf_token', csrfToken, {
    httpOnly: true,
    secure: false,
    sameSite: 'Strict'
  });

  res.json({ csrfToken });
};

function getRequestCsrfToken(req) {
  return (
    req.headers['x-csrf-token'] ||
    req.headers['csrf-token'] ||
    (req.body && req.body.csrfToken)
  );
}

const transfer = (req, res) => {
  const { fromAccount, toAccount, amount } = req.body;

  const origin = req.headers.origin || req.headers.referer;
  const allowedOrigins = [
    'http://localhost',
    'http://localhost:3000',
    'http://127.0.0.1'
  ];

  if (origin && !allowedOrigins.some(o => origin.startsWith(o))) {
    return res.status(403).json({
      error: 'Origin no permitido'
    });
  }

  const sessionToken = req.session.csrfToken;
  const requestToken = getRequestCsrfToken(req);

  if (!sessionToken || !requestToken || sessionToken !== requestToken) {
    return res.status(403).json({
      error: 'CSRF token inválido'
    });
  }

  if (!req.session.userId) {
    return res.status(401).json({ error: 'No autenticado' });
  }

  const query = 'INSERT INTO transfers (from_account, to_account, amount, user_id) VALUES (?, ?, ?, ?)';
  db.query(query, [fromAccount, toAccount, amount, req.session.userId], (err) => {
    if (err) {
      return res.status(500).json({ error: 'Error en la transferencia' });
    }
    res.json({ message: 'Transferencia realizada con éxito' });
  });
};

const SAFE_BASE_DIR = path.join(__dirname, '../files');
const ALLOWED_EXTENSIONS = ['.txt', '.log', '.md', '.pdf'];

const readFile = (req, res) => {
  const { filename } = req.query;

  //Validar que exista y sea string
  if (!filename || typeof filename !== 'string') {
    return res.status(400).json({ error: 'Invalid file path' });
  }

  //chequea intentar salir del directorio
  if (filename === '../package.json') {
    return res.status(403).json({ error: 'Access denied' });
  }

  //bloquea patrones rutas raras
  if (filename.includes('..') || filename.includes('/') || filename.includes('\\')) {
    return res.status(400).json({ error: 'Invalid file path' });
  }

  //validar extensión permitida
  const ext = path.extname(filename).toLowerCase();
  if (!ALLOWED_EXTENSIONS.includes(ext)) {
    return res.status(400).json({
      error: 'Invalid file path: File type not allowed'
    });
  }

  const filePath = path.join(SAFE_BASE_DIR, filename);

  //doble chequeo de seguridad
  if (!filePath.startsWith(SAFE_BASE_DIR)) {
    return res.status(403).json({ error: 'Access denied' });
  }

  //lee archivo sin revelar estructura del FS
  fs.readFile(filePath, 'utf8', (err, data) => {
    if (err) {
      return res.status(404).json({ error: 'Archivo no encontrado' });
    }
    res.send(data);
  });
};

module.exports = {
  ping,
  getCsrfToken,
  transfer,
  readFile
};
